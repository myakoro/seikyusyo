# 07. デプロイ設計・開発計画

## 7.1 デプロイ設計

### 7.1.1 Renderへのデプロイ概要

**デプロイ先**: Render（https://render.com/）

**デプロイ方式**: GitHubからの自動デプロイ（CI/CD）

**構成**

- **Web Service**: Next.jsアプリケーション
- **SQLite**: Local file database (persisted on Render Disk)

---

### 7.1.2 Renderプロジェクト構成

```mermaid
graph LR
    GitHub[GitHub Repository] -->|Push| Render[Render]
    Render --> WebService[Web Service<br/>Next.js App]
    Render --> DB[(PostgreSQL<br/>Database)]
    WebService --> DB
    
    style GitHub fill:#f9f
    style WebService fill:#9f9
    style DB fill:#99f
```

---

### 7.1.3 Web Service設定

**基本設定**

| 項目 | 設定値 |
|------|--------|
| Name | smart-order-mini |
| Environment | Node |
| Region | Singapore（日本に最も近い） |
| Branch | main |
| Build Command | `npm install && npm run build` |
| Start Command | `npm start` |
| Instance Type | Starter（無料枠）→ 必要に応じてアップグレード |

**環境変数（Environment Variables）**

| 変数名 | 説明 | 例 |
|--------|------|---|
| DATABASE_URL | PostgreSQL接続URL | `postgresql://user:pass@host:5432/db` |
| NEXTAUTH_URL | アプリケーションURL | `https://smart-order-mini.onrender.com` |
| NEXTAUTH_SECRET | NextAuth.jsシークレット | ランダム文字列（32文字以上） |
| NODE_ENV | 環境 | `production` |

**NEXTAUTH_SECRETの生成方法**

```bash
openssl rand -base64 32
```

---

### 7.1.4 PostgreSQL設定

**基本設定**

| 項目 | 設定値 |
|------|--------|
| Name | smart-order-mini-db |
| Database | smart_order_mini |
| User | 自動生成 |
| Region | Singapore |
| PostgreSQL Version | 15 |
| Plan | Starter（無料枠）→ 必要に応じてアップグレード |

**接続情報**

Renderが自動的に`DATABASE_URL`を生成し、Web Serviceの環境変数に設定

---

### 7.1.5 デプロイフロー

```mermaid
sequenceDiagram
    participant Dev as 開発者
    participant GitHub
    participant Render
    participant WebService
    participant DB
    
    Dev->>GitHub: git push
    GitHub->>Render: Webhook通知
    Render->>Render: ビルド開始
    Render->>Render: npm install
    Render->>Render: npm run build
    Render->>Render: Prisma migrate deploy
    Render->>WebService: デプロイ
    WebService->>DB: 接続確認
    Render-->>Dev: デプロイ完了通知
```

**ステップ**

1. 開発者がGitHubにコードをプッシュ
2. RenderがWebhookを受信
3. ビルドプロセス開始
   - `npm install`: 依存関係インストール
   - `npm run build`: Next.jsビルド
   - `npx prisma migrate deploy`: データベースマイグレーション実行
4. ビルド成功後、自動的にデプロイ
5. ヘルスチェック成功後、新バージョンに切り替え

---

### 7.1.6 ビルドコマンド設定

**package.jsonのscripts**

```json
{
  "scripts": {
    "dev": "next dev",
    "build": "prisma generate && next build",
    "start": "next start",
    "lint": "next lint",
    "postinstall": "prisma generate"
  }
}
```

**Renderのビルドコマンド**

```bash
npm install && npx prisma migrate deploy && npm run build
```

---

### 7.1.7 環境変数管理

**ローカル開発環境（.env.local）**

```env
DATABASE_URL="file:/var/data/prod.db"
NEXTAUTH_URL="http://localhost:3000"
NEXTAUTH_SECRET="your-local-secret-key"
NODE_ENV="development"
```

**本番環境（Render Dashboard）**

- Render Dashboardで環境変数を設定
- `.env.production`ファイルはGitにコミットしない（`.gitignore`に追加）

**.gitignore**

```
.env.local
.env.production
.env*.local
```

---

### 7.1.8 データベースマイグレーション

**開発環境**

```bash
npx prisma migrate dev --name init
```

**本番環境（Renderで自動実行）**

```bash
npx prisma migrate deploy
```

**マイグレーションファイル管理**

- `prisma/migrations/`ディレクトリをGitで管理
- 本番デプロイ時に自動的にマイグレーション実行

---

### 7.1.9 ログ・監視

**ログ確認**

- Render Dashboard > Logs
- リアルタイムログ表示
- 過去のログも閲覧可能

**監視項目**

- アプリケーションログ（console.log, console.error）
- ビルドログ
- デプロイログ
- データベース接続エラー

**アラート設定**

- Renderのビルトイン機能（デプロイ失敗時にメール通知）
- 将来的にSentry等の外部サービス導入を検討

---

### 7.1.10 バックアップ・復旧

**データベースバックアップ**

- Renderの自動バックアップ機能（日次）
- 手動バックアップ: Render Dashboard > Database > Backups

**復旧手順**

1. Render Dashboard > Database > Backups
2. 復旧したいバックアップを選択
3. "Restore"ボタンをクリック

**注意事項**

- 無料プランではバックアップ保持期間が限定的
- 重要なデータは定期的に手動バックアップを推奨

---

### 7.1.11 スケーリング

**垂直スケーリング（Instance Type変更）**

| プラン | vCPU | RAM | 価格/月 |
|--------|------|-----|---------|
| Starter | 0.5 | 512MB | 無料 |
| Standard | 1 | 2GB | $7 |
| Pro | 2 | 4GB | $25 |

**水平スケーリング**

- MVP版では単一インスタンスで運用
- 将来的に負荷が高まった場合、複数インスタンスに拡張可能

---

### 7.1.12 カスタムドメイン設定

**手順**

1. Render Dashboard > Settings > Custom Domain
2. ドメイン名を入力（例: `invoice.example.com`）
3. DNSレコードを設定
   - CNAME: `smart-order-mini.onrender.com`
4. SSL証明書が自動的に発行される（Let's Encrypt）

---

## 7.2 CI/CDパイプライン

### 7.2.1 GitHub Actionsの活用（オプション）

**目的**

- コードプッシュ前の自動テスト
- リンター・フォーマッターの自動実行

**ワークフロー例（.github/workflows/ci.yml）**

```yaml
name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - run: npm ci
      - run: npm run lint

  type-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - run: npm ci
      - run: npx tsc --noEmit

  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - run: npm ci
      - run: npm run build
```

---

### 7.2.2 デプロイ戦略

**ブランチ戦略**

```mermaid
gitGraph
    commit
    branch develop
    checkout develop
    commit
    commit
    checkout main
    merge develop tag: "v1.0.0"
    commit
```

- **main**: 本番環境（Renderに自動デプロイ）
- **develop**: 開発環境（ローカルまたはステージング）
- **feature/xxx**: 機能開発ブランチ

**デプロイフロー**

1. `feature/xxx`ブランチで機能開発
2. `develop`ブランチにマージ
3. 動作確認後、`main`ブランチにマージ
4. Renderが自動的に本番デプロイ

---

## 7.3 開発の進め方

### 7.3.1 フェーズ分け

#### フェーズ1: MVP（Minimum Viable Product）

**目標**: 基本機能の実装・リリース

**期間**: 4〜6週間

**実装機能**

- ユーザー認証（ログイン・ログアウト）
- フリーランス管理（登録・編集）
- 商品マスタ管理（登録・編集）
- 請求書作成・編集・削除
- 請求書ステータス管理（下書き→承認待ち→承認済→支払済）
- 金額自動計算
- PDF出力
- 自社情報設定

**スコープ外（フェーズ2以降）**

- 通知機能（メール自動送信）
- 集計・レポート機能
- 外部会計ソフト連携
- 複数税率対応

---

#### フェーズ2: 機能拡張

**目標**: ユーザビリティ向上・運用効率化

**期間**: 2〜4週間

**実装機能**

- メール自動送信（招待、請求書確定通知）
- ダッシュボード統計情報
- 請求書検索・フィルタ機能の強化
- 集計レポート（月次、年次）
- CSVエクスポート

---

#### フェーズ3: 高度な機能

**目標**: システムの完成度向上

**期間**: 4〜6週間

**実装機能**

- 外部会計ソフト連携（freee、マネーフォワード）
- 電子帳簿保存法対応
- 複数税率対応
- 権限管理の細分化
- 監査ログ閲覧機能

---

### 7.3.2 開発優先順位

**高優先度（MVP必須）**

1. データベース設計・構築
2. 認証機能
3. フリーランス・商品マスタ管理
4. 請求書CRUD機能
5. 金額計算ロジック
6. ステータス管理
7. PDF生成

**中優先度（MVP後すぐ）**

1. ダッシュボード
2. 検索・フィルタ機能
3. メール通知

**低優先度（将来拡張）**

1. 外部連携
2. 高度なレポート
3. 電子帳簿保存法対応

---

### 7.3.3 開発体制

**推奨体制**

- **フロントエンド**: Windsurf（UI実装）
- **バックエンド**: Anthropic Claude（API・ビジネスロジック実装）
- **デザイン**: 要件定義書に基づく
- **テスト**: 手動テスト + 将来的に自動テスト導入

**開発フロー**

1. **設計**: 詳細設計書に基づく
2. **実装**: 
   - Windsurfでフロントエンド実装
   - Claudeでバックエンド実装
3. **テスト**: 機能ごとに動作確認
4. **デプロイ**: GitHubにプッシュ → Renderが自動デプロイ
5. **検証**: 本番環境で動作確認

---

### 7.3.4 タスク管理

**推奨ツール**

- GitHub Issues
- GitHub Projects

**タスク例**

```markdown
## タスク: 請求書作成機能の実装

### 概要
請求書作成画面とAPIを実装する

### チェックリスト
- [ ] データベーステーブル作成（Invoice, InvoiceItem）
- [ ] API実装（POST /api/invoices）
- [ ] フロントエンド実装（/invoices/new）
- [ ] 金額計算ロジック実装
- [ ] バリデーション実装
- [ ] テスト

### 担当
- フロントエンド: Windsurf
- バックエンド: Claude

### 期限
2024-12-15
```

---

### 7.3.5 テスト計画

#### 単体テスト（将来実装）

**対象**

- 金額計算ロジック
- ビジネスロジック（ステータス遷移、請求書番号採番）

**ツール**: Jest

---

#### 統合テスト（将来実装）

**対象**

- API エンドポイント
- データベース操作

**ツール**: Jest + Supertest

---

#### 手動テスト（MVP）

**テストケース例**

| テストケース | 手順 | 期待結果 |
|------------|------|---------|
| 請求書作成 | 1. フリーランス選択<br>2. 明細入力<br>3. 確定 | 請求書番号が採番され、ステータスが「承認待ち」になる |
| 金額計算 | 1. 明細に単価100,000、個数1、報酬率100%を入力 | 金額が100,000、請求額が99,790になる |
| PDF出力 | 1. 請求書詳細画面でPDF出力 | PDFがダウンロードされ、内容が正しい |

---

### 7.3.6 リリース計画

#### MVP リリース

**リリース日**: 開発開始から6週間後（目標）

**リリース前チェックリスト**

- [ ] 全機能の動作確認
- [ ] セキュリティチェック
- [ ] パフォーマンステスト
- [ ] データベースバックアップ設定
- [ ] 本番環境変数設定
- [ ] ドキュメント整備（ユーザーマニュアル）

**リリース手順**

1. `main`ブランチにマージ
2. Renderが自動デプロイ
3. デプロイ完了確認
4. 本番環境で動作確認
5. ユーザーに通知

---

#### 段階的リリース（推奨）

**フェーズ1: 社内テスト**

- 自社ユーザーのみで運用
- フィードバック収集

**フェーズ2: 限定公開**

- 一部のフリーランスに招待
- 実運用でのテスト

**フェーズ3: 本格運用**

- 全フリーランスに展開
- 継続的な改善

---

## 7.4 運用・保守

### 7.4.1 定期メンテナンス

**月次タスク**

- データベースバックアップ確認
- ログレビュー
- セキュリティアップデート確認

**四半期タスク**

- パフォーマンスレビュー
- ユーザーフィードバック収集・対応
- 機能改善計画

---

### 7.4.2 トラブルシューティング

**よくある問題と対処法**

| 問題 | 原因 | 対処法 |
|------|------|--------|
| ログインできない | パスワード忘れ | パスワードリセット手順を案内 |
| PDF生成エラー | フォントファイル不足 | フォントファイルを確認・再配置 |
| データベース接続エラー | DATABASE_URL設定ミス | 環境変数を確認 |
| デプロイ失敗 | ビルドエラー | ログを確認し、エラー箇所を修正 |

---

### 7.4.3 サポート体制

**問い合わせ窓口**

- メール: support@example.com
- 社内チャット: Slack等

**対応時間**

- 平日 9:00〜18:00（MVP版）

---

## 7.5 まとめ

### 7.5.1 システム全体像

```mermaid
graph TB
    subgraph "ユーザー"
        Company[自社ユーザー]
        Freelancer[フリーランス]
    end
    
    subgraph "Render"
        subgraph "Next.js Application"
            Frontend[フロントエンド]
            API[API Routes]
            Auth[NextAuth.js]
            PDF[PDF生成]
        end
        DB[(PostgreSQL)]
    end
    
    subgraph "開発"
        GitHub[GitHub]
        Windsurf[Windsurf<br/>UI実装]
        Claude[Claude<br/>バックエンド実装]
    end
    
    Company --> Frontend
    Freelancer --> Frontend
    Frontend --> API
    API --> Auth
    API --> PDF
    API --> DB
    
    Windsurf --> GitHub
    Claude --> GitHub
    GitHub --> Render
```

---

### 7.5.2 次のステップ

1. **環境構築**
   - GitHubリポジトリ作成
   - Renderアカウント作成
   - ローカル開発環境セットアップ

2. **データベース構築**
   - Prismaスキーマ作成
   - マイグレーション実行

3. **認証機能実装**
   - NextAuth.js設定
   - ログイン画面実装

4. **コア機能実装**
   - フリーランス管理
   - 商品マスタ管理
   - 請求書管理

5. **テスト・デプロイ**
   - 動作確認
   - 本番デプロイ

---

### 7.5.3 参考リンク

- **Next.js**: https://nextjs.org/docs
- **Prisma**: https://www.prisma.io/docs
- **NextAuth.js**: https://next-auth.js.org/
- **Render**: https://render.com/docs
- **React PDF**: https://react-pdf.org/

---

**以上で詳細設計書は完了です。**

この設計書に基づいて、Windsurfでフロントエンド、Claudeでバックエンドを実装してください。
