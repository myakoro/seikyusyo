# 01. システム前提条件・構成

## 1.1 システム前提条件

### 開発環境
- **開発OS**: Windows
- **対応ブラウザ**: Google Chrome（最新版）
- **バージョン管理**: GitHub
- **UI実装ツール**: Windsurf（フロントエンド開発ツール）
- **バックエンド実装**: Anthropic（Claude）

### デプロイ環境
- **デプロイ先**: Render
- **デプロイ方式**: GitHubからの自動デプロイ（CI/CD）
- **HTTPS**: 必須（Renderが自動提供）

### 想定利用者数
- 自社ユーザー: 数名〜数十名
- フリーランス: 数名〜数十名
- 合計: 最大100名程度の同時アクセスを想定

---

## 1.2 技術スタック

### フロントエンド
- **フレームワーク**: Next.js 14+ (App Router)
- **言語**: TypeScript
- **UIライブラリ**: React 18+
- **スタイリング**: Tailwind CSS
- **フォーム管理**: React Hook Form
- **バリデーション**: Zod
- **状態管理**: React Context API（必要に応じてZustand）
- **日付処理**: date-fns

### バックエンド
- **フレームワーク**: Next.js API Routes（フルスタック構成）
- **言語**: TypeScript
- **認証**: NextAuth.js v5
- **ORM**: Prisma
- **PDF生成**: @react-pdf/renderer または PDFKit

### データベース
- **DBMS**: SQLite
- **ホスティング**: Render Disk (Persistent Storage)
- **マイグレーション**: Prisma Migrate

### デプロイ・インフラ
- **ホスティング**: Render（Web Service）
- **データベース**: SQLite (on Render Disk)
- **ストレージ**: Render Disk（DB & PDF保存用）
- **環境変数管理**: Render Environment Variables
- **CI/CD**: GitHub連携による自動デプロイ

### 開発ツール
- **パッケージマネージャー**: npm または pnpm
- **リンター**: ESLint
- **フォーマッター**: Prettier
- **型チェック**: TypeScript

---

## 1.3 システムアーキテクチャ

### 全体構成

```mermaid
graph TB
    subgraph "クライアント"
        Browser[Webブラウザ<br/>Chrome]
    end
    
    subgraph "Render"
        subgraph "Next.js Application"
            Frontend[フロントエンド<br/>React/Next.js]
            API[API Routes<br/>Next.js]
            Auth[認証<br/>NextAuth.js]
            PDF[PDF生成<br/>@react-pdf/renderer]
            SQLite[(SQLite<br/>dev.db)]
        end
        
        Storage[Render Disk<br/>/var/data]
    end
    
    Browser -->|HTTPS| Frontend
    Frontend -->|API Call| API
    API -->|認証| Auth
    API -->|ORM| SQLite
    API -->|生成| PDF
    SQLite -->|Persist| Storage
    PDF -->|保存| Storage
    
    style Browser fill:#e1f5ff
    style Frontend fill:#fff4e1
    style API fill:#ffe1f5
    style SQLite fill:#e1ffe1
    style Storage fill:#f5e1ff
```

### アプリケーション構成

**モノリシック構成（Next.js フルスタック）**

- フロントエンドとバックエンドを同一Next.jsアプリケーション内に実装
- API RoutesでRESTful APIを提供
- サーバーサイドレンダリング（SSR）とクライアントサイドレンダリング（CSR）を適切に使い分け
- 認証状態の管理はNextAuth.jsで一元化

---

## 1.4 ディレクトリ構成

```
smart-order-mini/
├── prisma/
│   ├── schema.prisma          # Prismaスキーマ定義
│   └── migrations/            # マイグレーションファイル
├── public/                    # 静的ファイル
├── src/
│   ├── app/                   # Next.js App Router
│   │   ├── (auth)/           # 認証関連ページグループ
│   │   │   ├── login/
│   │   │   └── reset-password/
│   │   ├── (dashboard)/      # ダッシュボードグループ
│   │   │   ├── invoices/     # 請求書管理
│   │   │   ├── freelancers/  # フリーランス管理
│   │   │   ├── products/     # 商品マスタ管理
│   │   │   └── settings/     # 設定
│   │   ├── api/              # API Routes
│   │   │   ├── auth/         # 認証API
│   │   │   ├── invoices/     # 請求書API
│   │   │   ├── freelancers/  # フリーランスAPI
│   │   │   ├── products/     # 商品API
│   │   │   └── pdf/          # PDF生成API
│   │   └── layout.tsx        # ルートレイアウト
│   ├── components/           # Reactコンポーネント
│   │   ├── ui/              # 汎用UIコンポーネント
│   │   ├── forms/           # フォームコンポーネント
│   │   └── layouts/         # レイアウトコンポーネント
│   ├── lib/                 # ユーティリティ・ヘルパー
│   │   ├── prisma.ts        # Prismaクライアント
│   │   ├── auth.ts          # NextAuth設定
│   │   ├── calculations.ts  # 金額計算ロジック
│   │   └── pdf.ts           # PDF生成ロジック
│   ├── types/               # TypeScript型定義
│   └── middleware.ts        # Next.js Middleware（認証チェック）
├── .env.local               # ローカル環境変数
├── .env.production          # 本番環境変数（Renderで設定）
├── package.json
├── tsconfig.json
└── next.config.js
```

---

## 1.5 環境構成

### 開発環境（ローカル）

- **アプリケーション**: `localhost:3000`
- **データベース**: ローカルPostgreSQL または Docker
- **環境変数**: `.env.local`

### 本番環境（Render）

- **アプリケーション**: `https://smart-order-mini.onrender.com`（例）
- **データベース**: Render Managed PostgreSQL
- **環境変数**: Render Dashboard で設定

---

## 1.6 外部サービス連携

### 必須サービス
- **Render**: アプリケーションホスティング、データベース
- **GitHub**: ソースコード管理、CI/CDトリガー

### 将来拡張候補（MVP外）
- **メール送信**: SendGrid、AWS SES等（招待メール自動送信）
- **ストレージ**: AWS S3、Cloudflare R2等（PDF長期保存）
- **会計ソフト連携**: freee API、マネーフォワード API

---

## 1.7 セキュリティ要件

- **通信**: HTTPS必須（Renderが自動提供）
- **認証**: セッションベース認証（NextAuth.js）
- **パスワード**: bcryptによるハッシュ化（コスト係数10以上）
- **CSRF対策**: Next.jsのビルトイン機能 + NextAuth.js
- **XSS対策**: Reactの自動エスケープ + Content Security Policy
- **SQLインジェクション対策**: Prisma ORMのパラメータ化クエリ

---

## 1.8 パフォーマンス要件

- **ページ読み込み**: 初回3秒以内、以降1秒以内
- **API応答時間**: 平均500ms以内
- **同時接続**: 100ユーザーまで対応
- **データベース**: インデックス最適化、N+1クエリ回避

---

## 1.9 バックアップ・復旧

- **データベースバックアップ**: Renderの自動バックアップ機能（日次）
- **手動バックアップ**: 重要な操作前に手動でスナップショット取得
- **復旧手順**: Renderダッシュボードからリストア

---

## 1.10 監視・ログ

- **アプリケーションログ**: Renderのログ機能
- **エラー監視**: console.error + Renderログ（将来的にSentry等導入可）
- **アクセスログ**: Next.jsのビルトイン機能
- **パフォーマンス監視**: Renderのメトリクス

---

## 次のドキュメント

- [02_データベース設計.md](./02_データベース設計.md)
