# スマート受発注 mini 要件定義書

## 1. 背景・目的

### 1.1 背景
自社では、フリーランスへの業務委託（外注）を行っている。
現在は、メールとExcel／Wordで「見積・発注・請求」のやり取りをしており、以下の問題がある。

- 発注内容と請求金額の齟齬が起きやすい
- 源泉所得税や消費税の計算・記載が毎回手作業でミスしやすい
- 誰とどの案件がどのステータスか（発注中／請求待ち／支払済み）が追いづらい

### 1.2 目的
自社（発注者）と外注フリーランス（受注者）との請求・支払の流れをWebシステム上で一元管理する。

- フリーランスごとの請求書を作成し、源泉所得税（10.21％）と消費税を自動計算する
- フリーランス情報と商品情報を事前登録することで、請求書作成時の入力を効率化する

## 2. 前提条件

### 2.1 基本前提
- 役割は固定：自社＝発注者、フリーランス＝受注者
- 取引は日本国内を想定し、日本の消費税・源泉所得税のルールを前提とする
- 発注のやり取りはシステム外で実施し、請求書の作成・管理をシステムで行う
- 外部会計ソフトとの自動連携は不要（将来拡張の余地としては残してもよい）
- 電子帳簿保存法などの厳密な法対応はMVPでは「最低限のデータ保存」にとどめる（将来拡張可）

### 2.2 スコープ外（MVP外）
以下の機能はMVPのスコープ外とし、将来拡張として位置づける。

- 外部会計ソフトとの自動連携（freee、マネーフォワードなど）
- 電子帳簿保存法の厳密な対応（タイムスタンプなど）
- 電子契約（電子署名）
- 複数税率対応（軽減税率8％など）
- 明細行の並び順変更機能（商品マスタに表示順を持たせる等）
- 下書きPDFへの透かし表示

## 3. 機能要件

### 3.1 ユーザー・権限管理

#### 3.1.1 ユーザー種別
以下の2種類のユーザーを管理する。

- **自社ユーザー（請求書作成者）**：請求書の作成・編集・支払管理が可能
- **フリーランス**：自分に紐づく請求書の閲覧、承認・差し戻し、および自分の登録情報（氏名、住所、振込先等）の編集が可能

※MVPでは自社ユーザーは全員同じ権限を持ち、全ての請求書を閲覧・編集可能

**自社ユーザーの登録**
- システム構築時に初期管理者アカウントを1つ作成
- 初期管理者が他の自社ユーザーを登録し、招待URL・ID・仮パスワードを手動送信
- 登録後、各ユーザーがログインしてパスワードを変更

#### 3.1.2 ログイン・ログアウト
- **ログイン**：ID（またはメールアドレス）とパスワードで認証
- ログイン画面では、前回ログインしたIDを記憶しておく（入力の手間を省く）
- **ログアウト**：全画面にログアウトボタンを配置。ログアウト後はログイン画面に遷移

#### 3.1.3 招待フロー（フリーランス）
- 自社ユーザーがフリーランス情報を登録（氏名、メールアドレス等）
- 登録完了時に、招待URL・ID・仮パスワードを含む連絡文のテンプレートが表示される
- 自社ユーザーがその文面をコピーして、メールやチャット等で手動送信
- フリーランスが招待URLからログインし、パスワードを変更
- ログイン後、フリーランス本人が自分の詳細情報（住所、振込先等）を編集・補完
- 招待URLの有効期限はなし（MVPではシンプルに無期限とする）

#### 3.1.4 パスワードリセット
- ユーザーがパスワードを忘れた場合、「パスワードを忘れた方」リンクからメールアドレス（またはID）を入力
- 自社の管理者画面でリセット用URL・仮パスワードを生成
- 管理者がその情報をコピーして、手動でユーザーに送信
- ユーザーはリセット用URLからログインし、新しいパスワードを設定できる

### 3.2 フリーランス・商品マスタ管理

#### 3.2.1 フリーランス情報の登録
自社ユーザーが以下の情報を登録・管理する。

- 基本情報：氏名（または屋号）、住所、電話番号、メールアドレス
- インボイス番号（適格請求書発行事業者登録番号）：任意項目
- 振込先情報：銀行名、支店名、口座種別、口座番号、口座名義
- ステータス（有効／無効）
- その他：源泉税対象デフォルト設定など

※登録後、招待URLを通じてフリーランス本人も自分の情報を編集・補完できる（詳細は3.1.3参照）
※「無効」にすると新規請求書作成時の選択肢に表示されない（過去の請求書データは保持される）

#### 3.2.2 商品マスタの登録
各フリーランスに紐づく形で、以下の商品情報を登録する。

- 商品名／作業名
- 単価
- 消費税設定（込／別）
- 消費税率（デフォルト10.0%）
- 源泉税対象（対象／対象外）
- ステータス（有効／無効）

※「有効」の商品のみが請求書作成時に明細テーブルに自動表示される
※商品マスタは自社ユーザーが登録・編集する

#### 3.2.3 自社情報の登録
請求書に表示する自社情報を登録する。

- 会社名、住所、電話番号
- その他、請求書に記載が必要な情報

※自社ユーザーであれば誰でも編集可能（MVPでは権限を細かく分けない）

### 3.3 請求書管理

#### 3.3.0 請求書番号
- **採番ルール**：自動採番（形式：`YYYYMM-XXXX`）
- 年月は請求締日を基準とする
- 連番（XXXX）は月ごとにリセット
- 例：2024年11月30日締め → `202411-0001`
- **採番タイミング**：自社側で「確定」ボタンを押した時に確定する。下書き中に請求締日を変更した場合、確定時の請求締日に基づいて番号が採番される

#### 3.3.1 請求書作成の流れ
1. **フリーランスを選択** → 請求書作成画面へ遷移
2. **作成者が自動記録される**
   - ログイン中の自社ユーザーが作成者として記録される
3. **発注者情報・受注者情報が自動入力される**
   - 自社情報（発注者）
   - 選択したフリーランスの情報（受注者）
4. **明細テーブルにそのフリーランスの有効な商品が表示される**
   - 商品マスタで「有効」になっている商品のみ自動表示
   - 商品名、単価などが自動入力済み
   - 自動入力された商品名・単価は手動で修正可能
   - 個数、報酬率（小数点第一位まで入力可能）を入力
   - 不要な行は削除可能（削除すると行が自動的に詰まる）
   - 「明細行を追加」ボタンで空行を追加可能（商品マスタにない新規商品を手動入力できる）
5. **請求締日・支払予定日が自動入力される**
   - 請求締日：起票した前月末がデフォルト
   - 支払予定日：締日の翌月末がデフォルト
   - 両方とも手動で変更可能
6. **備考欄を入力（任意）**
   - 請求書全体の備考欄に特記事項、支払条件などを自由記入できる
7. **金額が自動計算される**
   - 各明細の金額
   - 小計、源泉税対象小計、合計（税込）、源泉所得税、請求額（税込）
8. **「下書き保存」または「確定」を選択**
   - **下書き保存**：後で編集を再開できる
   - **確定**：確定完了メッセージと、フリーランスへ送る連絡文のテンプレートが表示される。連絡文にはログインURL、承認・差し戻し方法が記載されており、コピーして使用できる
9. **フリーランスが内容を確認し、承認または差し戻しを選択**
   - **承認**：請求書が正式に確定される
   - **差し戻し**：コメントを入力して自社側に差し戻す
10. **差し戻された場合**
   - 自社側で内容を訂正
   - 再度「確定」ボタンを押して承認依頼
11. **承認後、自社側で支払処理を行う**
    - 実支払日を入力して「支払済」ステータスに変更

#### 3.3.2 明細テーブルの構成
請求書は以下の列で構成される明細テーブルを持つ。

| 列名 | 説明 |
|------|------|
| 商品名／作業名 | 商品マスタから自動入力（手動修正可） |
| 単価 | 商品マスタから自動入力（手動修正可） |
| 個数 | ユーザーが入力 |
| 報酬率(%) | ユーザーが入力（0〜100、小数点第一位まで入力可能、0なら固定単価扱い） |
| 消費税 込別 | 商品マスタから自動入力（手動変更可：「込」「別」） |
| 消費税率 | 商品マスタから自動入力（手動変更可：小数点第一位まで入力可能、デフォルト10.0） |
| 源泉税対象 | 商品マスタから自動入力（手動変更可：「対象」「対象外」） |
| 金額 | 単価 × 個数 × (報酬率/100) で自動計算 |

※報酬率が100%の場合：金額 = 単価 × 個数
※報酬率が0%の場合：金額 = 単価（固定金額、個数は入力不要または1固定）

#### 3.3.3 請求書一覧・検索
請求書一覧画面で以下の機能を提供する。

**検索・フィルタ条件**
- ステータス（下書き、承認待ち、差し戻し、承認済、支払済）
- フリーランス名
- 作成者（自社ユーザー）
- 作成日期間
- 請求締日期間
- 支払予定日期間

**ソート**
- 作成日（昇順・降順）
- 請求締日（昇順・降順）
- 支払予定日（昇順・降順）
- 金額（昇順・降順）

#### 3.3.4 請求書の日付管理
- **請求締日**：デフォルトで起票した前月末（手動変更可）
- **支払予定日**：デフォルトで締日の翌月末（手動変更可）
- **実支払日**：支払済にする際に入力必須

例：2024年12月15日に起票した場合
- 請求締日：2024年11月30日（自動入力）
- 支払予定日：2024年12月31日（自動入力）

#### 3.3.5 請求書の編集・削除・複製

**編集制限**
- **下書き**：自由に編集可能
- **承認待ち**：編集可能。ただし、編集するとステータスが「下書き」に戻る（再確定が必要）
- **差し戻し**：編集可能
- **承認済**：編集不可（修正が必要な場合は新規請求書を作成）
- **支払済**：編集不可

**削除**
- **下書き**：削除可能（物理削除）
- **承認待ち以降**：削除不可（監査対応のため記録を保持）

**複製**
- 請求書一覧から「複製」ボタンで同じ内容の新規請求書を作成可能
- 複製元の明細・金額がコピーされ、請求締日・支払予定日は再計算される
- ステータスは「下書き」となる

#### 3.3.6 情報のスナップショット保存
自社側で「確定」ボタンを押した時に、以下の情報をスナップショットとして請求書に保存する。

- 自社情報（会社名、住所、電話番号等）
- フリーランス情報（氏名、住所、インボイス番号等）

※後から自社情報やフリーランス情報が変更されても、過去の請求書PDFは確定時の情報で出力される

### 3.4 ステータス管理

#### 3.4.1 請求書ステータス
請求書は以下のステータスで管理される。

- 下書き
- 承認待ち（自社側で確定ボタンを押した状態）
- 差し戻し（フリーランスがコメント付きで差し戻した状態）
- 承認済（フリーランスが承認した状態）
- 支払済

#### 3.4.2 変更履歴
- 誰が・いつ・どのステータスに変更したか、金額変更、承認・差し戻しのコメントなどの操作ログを保存する

### 3.5 PDF出力

#### 3.5.1 出力対象
- 請求書PDF

#### 3.5.2 PDF要件
- 請求書として必要な情報が記載されたレイアウト
- 表示項目：請求書番号、請求日（請求締日）、発注者情報、受注者情報、明細テーブル、備考、集計（小計・源泉対象小計・税込合計・源泉所得税・請求額）

#### 3.5.3 出力タイミング
- 全てのステータスでPDF出力可能
- 下書き中でもプレビュー・出力が可能

### 3.6 金額計算

#### 3.6.1 計算項目
請求書単位で以下の金額を自動計算する。

1. **小計（税別）**
   - 全明細の「税抜金額」の合計
   - 消費税「別」の明細：金額＝税抜金額としてそのまま集計
   - 消費税「込」の明細：金額から税率を使って税抜金額を逆算してから集計

2. **内、源泉税対象小計（税別）**
   - 明細のうち「源泉税対象＝対象」の行だけを集計した税抜金額の合計

3. **合計（税込）**
   - 各明細ごとに以下を計算し、全明細分を合計
     - 消費税「別」：税抜金額 × (1 + 消費税率/100)
     - 消費税「込」：金額を税込としてそのまま扱う

4. **源泉所得税**
   - 「源泉税対象小計（税別） × 10.21％」を計算し、1円未満切り捨て
   - 個人への報酬・料金の標準的な源泉徴収率（10.21％）に基づく
   - 100万円超の請求は、システム外で個別計算する運用とする（MVP）

5. **請求額（税込）**
   - 請求額（税込）＝ 合計（税込） − 源泉所得税

#### 3.6.2 明細行の金額計算
各明細行の金額は以下の式で計算する。

- **基本式**：金額 = 単価 × 個数 × (報酬率 / 100)
- **報酬率が100%の場合**：金額 = 単価 × 個数
- **報酬率が0%の場合**：金額 = 単価（固定金額、個数は入力不要または1固定）

## 4. 非機能要件

### 4.1 利用環境
- Webブラウザ経由でアクセス可能なシステム
- 想定利用者数：自社側数名〜数十名、フリーランス数名〜数十名程度

### 4.2 セキュリティ
- ユーザー認証必須（パスワード認証）
- 通信はHTTPSで暗号化

### 4.3 データ保持
- 請求書データは複数年分保持できること（具体的な年数は別途協議）

### 4.4 稼働時間
- 基本的に24時間365日アクセス可能であることが望ましい

## 5. 補足事項

### 5.1 今後の検討事項
以下の項目は要件定義時点では未確定であり、詳細設計時に決定する。

- 通知機能の詳細仕様（通知タイミング、通知手段）
- 集計・レポート機能の詳細（月次集計、源泉所得税年間合計など）
- 振込手数料の扱い（将来拡張）
- 支払方法の選択肢追加（将来拡張）

---

**文書履歴**

| 版 | 日付 | 作成者 | 備考 |
|---|------|--------|------|
| 1.0 | 2025-XX-XX | - | 初版作成 |
